<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <title>Automatic UDP Sender</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      max-width: 600px;
      margin: 2rem auto;
      padding: 0 1rem;
    }
    label {
      display: block;
      margin-top: 0.75rem;
    }
    input {
      width: 100%;
      padding: 0.4rem;
      box-sizing: border-box;
      margin-top: 0.25rem;
    }
    button {
      margin-top: 1rem;
      padding: 0.6rem 1.2rem;
      cursor: pointer;
    }
    .result {
      margin-top: 1rem;
      padding: 0.75rem;
      border-radius: 4px;
      background: #f5f5f5;
      white-space: pre-wrap;
      font-size: 0.9rem;
    }
    .error {
      color: #b00020;
    }
    .success {
      color: #006400;
    }
    .blocked {
      color: #8a2be2;
    }
  </style>
</head>
<body>
  <h1>Automatic UDP Sender</h1>

  <p>
    Specifica una subnet in notazione base e la CIDR. Se inserisci una CIDR &lt; 18,
    verr√† automaticamente usato 18.
  </p>
  <ul>
    <li>una frase casuale da <code>preghierine.txt</code></li>
    <li>un IP casuale nella subnet</li>
    <li>una porta UDP casuale nell'intervallo</li>
  </ul>

  <form id="sendForm">
    <label>
      Subnet (es. 1.2.3.0)
      <input type="text" id="subnet" value="1.2.3.0" required>
    </label>

    <label>
      CIDR (es. 24, minimo effettivo 18)
      <input type="number" id="cidr" min="0" max="32" value="24" required>
    </label>

    <label>
      Porta minima
      <input type="number" id="minPort" value="1024" min="1" max="65535" required>
    </label>

    <label>
      Porta massima
      <input type="number" id="maxPort" value="65535" min="1" max="65535" required>
    </label>

    <button type="submit">Invia frase casuale via UDP</button>
  </form>

  <div id="result" class="result" style="display:none;"></div>

  <script>
    const form = document.getElementById("sendForm");
    const resultDiv = document.getElementById("result");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      resultDiv.style.display = "none";
      resultDiv.textContent = "";

      const subnet = document.getElementById("subnet").value.trim();
      const cidrRaw = document.getElementById("cidr").value.trim();
      const minPort = document.getElementById("minPort").value;
      const maxPort = document.getElementById("maxPort").value;

      const payload = {
        subnet,
        cidr: parseInt(cidrRaw, 10),
        minPort: parseInt(minPort, 10),
        maxPort: parseInt(maxPort, 10),
      };

      try {
        const res = await fetch("http://localhost:5000/api/send-random", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(payload),
        });

        const data = await res.json();
        resultDiv.style.display = "block";

        if (!res.ok || data.error) {
          resultDiv.className = "result error";
          resultDiv.textContent = "Errore: " + (data.error || `HTTP ${res.status}`);
        } else if (data.status === "blocked") {
          resultDiv.className = "result blocked";
          resultDiv.textContent =
            "Richiesta bloccata.\n\n" +
            "Motivo: " + data.message + "\n" +
            "IP (candidato) di destinazione: " + data.targetIp + "\n" +
            "Subnet (CIDR): " + data.subnetCidr;
        } else {
          resultDiv.className = "result success";
          const cidrEff = data.cidrEffective ?? "(non disponibile)";
          resultDiv.textContent =
            "Frase inviata con successo.\n\n" +
            "Frase: " + data.messageSent + "\n" +
            "IP di destinazione: " + data.targetIp + "\n" +
            "Porta: " + data.targetPort + "\n" +
            "Subnet (CIDR): " + data.subnetCidr + "\n" +
            "CIDR effettiva usata: " + cidrEff;
        }
      } catch (err) {
        resultDiv.style.display = "block";
        resultDiv.className = "result error";
        resultDiv.textContent = "Errore di rete lato client: " + err;
      }
    });
  </script>
</body>
</html>
